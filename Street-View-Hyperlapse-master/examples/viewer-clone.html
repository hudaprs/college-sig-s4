<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<title>Viewer Example Clone</title>

		<!-- 
	BAIKNYA GUNAKAN GOOGLE MAP API KEY ANDA SENDIRI, by rae
	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCw_C65k-ltqG5lAO12hcnD118nSdkA9jw&sensor=false" type="text/javascript"></script> 
	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDcNfPU5Xhy2zxtoZKfkLUnpJvtWLLozbY&sensor=false" type="text/javascript"></script> 
	
	BAIKNYA GUNAKAN GOOGLE MAP API KEY ANDA SENDIRI, by rae
	
	-->

		<script
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDcNfPU5Xhy2zxtoZKfkLUnpJvtWLLozbY&sensor=false"
			type="text/javascript"
		></script>

		<script src="js/dat.gui.min.js"></script>
		<script src="js/three.min.js"></script>
		<script src="js/GSVPano.js"></script>
		<script src="../src/Hyperlapse.js"></script>
		<script>
			//INI YANG PALING PENTING .. DUA TITIK yang akan di running street view nya, by rae
			var start_point = new google.maps.LatLng(
				-7.648043599419241,
				107.71371750798505
			)

			var end_point = new google.maps.LatLng(
				-7.668674859139654,
				107.6954952656177
			)

			// ini lookat point sebenernya buat rekaman melihat ke suatu titik, by rae
			// untuk amannya samakan variabel ini dengan var end point =
			var lookat_point = end_point

			//ini nilai tengah antara dua titik supaya peta ditengah, by rae
			var start_tengah = new google.maps.LatLng(
				-7.656965394819751,
				107.70030979494639
			)

			var map,
				directions_renderer,
				directions_service,
				streetview_service,
				geocoder
			var start_pin, end_pin, pivot_pin, camera_pin
			var _elevation = 0
			var _route_markers = []

			function show(msg) {
				document.getElementById('text').innerHTML = msg
			}

			function init() {
				if (window.location.hash) {
					parts = window.location.hash.substr(1).split(',')
					start_point = new google.maps.LatLng(parts[0], parts[1])
					lookat_point = new google.maps.LatLng(parts[2], parts[3])
					end_point = new google.maps.LatLng(parts[4], parts[5])
					_elevation = parts[6] || 0
				}

				/* Map */

				function snapToRoad(point, callback) {
					var request = {
						origin: point,
						destination: point,
						travelMode: google.maps.TravelMode['DRIVING']
					}
					directions_service.route(request, function (response, status) {
						if (status == 'OK') callback(response.routes[0].overview_path[0])
						else callback(null)
					})
				}

				function changeHash() {
					window.location.hash =
						start_pin.getPosition().lat() +
						',' +
						start_pin.getPosition().lng() +
						',' +
						pivot_pin.getPosition().lat() +
						',' +
						pivot_pin.getPosition().lng() +
						',' +
						end_pin.getPosition().lat() +
						',' +
						end_pin.getPosition().lng() +
						',' +
						_elevation
				}

				var mapOpt = {
					// DISINI Kita MENENTUKAN jenis peta yang di support oleh google maps, by rae

					mapTypeId: google.maps.MapTypeId.ROADMAP,
					// mapTypeId: google.maps.MapTypeId.HYBRID,
					// mapTypeId: google.maps.MapTypeId.SATELLITE,
					// mapTypeId: google.maps.MapTypeId.TERRAIN,

					// fullscreenControl: false,
					disableDefaultUI: true,

					/* 
					center: start_point, 
				*/
					center: start_tengah,

					zoom: 13,
					streetViewControl: true // Enable Street View control
				}

				// const panorama = new google.maps.StreetViewPanorama(
				// 	document.getElementById('map'),
				// 	{
				// 		position: { lat: 51.507351, lng: -0.127758 }, // Replace with your desired location
				// 		pov: { heading: 0, pitch: 0 } // Initial camera position
				// 	}
				// )

				map = new google.maps.Map(document.getElementById('map'), mapOpt)
				// map.setStreetView(panorama)
				geocoder = new google.maps.Geocoder()

				var overlay = new google.maps.StreetViewCoverageLayer()
				overlay.setMap(map)

				directions_service = new google.maps.DirectionsService()
				directions_renderer = new google.maps.DirectionsRenderer({
					draggable: false,
					markerOptions: { visible: false }
				})
				directions_renderer.setMap(map)
				directions_renderer.setOptions({ preserveViewport: true })

				camera_pin = new google.maps.Marker({
					position: start_point,
					map: map
				})

				start_pin = new google.maps.Marker({
					position: start_point,
					draggable: true,
					map: map
				})

				google.maps.event.addListener(start_pin, 'dragend', function (event) {
					snapToRoad(start_pin.getPosition(), function (result) {
						start_pin.setPosition(result)
						start_point = result
						changeHash()
					})
				})

				end_pin = new google.maps.Marker({
					position: end_point,
					draggable: true,
					map: map
				})

				google.maps.event.addListener(end_pin, 'dragend', function (event) {
					snapToRoad(end_pin.getPosition(), function (result) {
						end_pin.setPosition(result)
						end_point = result
						changeHash()
					})
				})

				pivot_pin = new google.maps.Marker({
					position: lookat_point,
					draggable: true,
					map: map
				})

				google.maps.event.addListener(pivot_pin, 'dragend', function (event) {
					hyperlapse.setLookat(pivot_pin.getPosition())
					changeHash()
				})

				function findAddress(address) {
					geocoder.geocode({ address: address }, function (results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							map.setCenter(results[0].geometry.location)
							o.drop_pins()
						} else {
							show(
								'Geocode was not successful for the following reason: ' + status
							)
						}
					})
				}

				var search = document.getElementById('searchButton')
				search.addEventListener(
					'click',
					function (event) {
						event.preventDefault()
						findAddress(document.getElementById('address').value)
					},
					false
				)

				/* Hyperlapse */

				var pano = document.getElementById('pano')
				var is_moving = false
				var px, py
				var onPointerDownPointerX = 0,
					onPointerDownPointerY = 0

				var hyperlapse = new Hyperlapse(pano, {
					lookat: lookat_point,
					fov: 80,
					// millis, untuk mengatur kecepatan frame, semakin rendah semakin cepat, semakin tinggi semakin lambat pergerakan frame, by rae
					millis: 1000,
					width: window.innerWidth,
					height: window.innerHeight,
					zoom: 2,
					use_lookat: false,
					distance_between_points: 1,

					// max points adalah banyak Frame/Foto yang diambil
					// hati2 dengan variabel max points ini jangan besar2 kalau Laptop/Komputer anda tidak punya memory besar
					// sebagai patokan bila Laptop/Komputer kamu RAM 2 GB yah setting max points: 50 atau 100
					// kalo laptop kamu RAM 4 GB boleh setting max points: 100 atau 200
					// kalo laptop kamu RAM 8 GB boleh setting max points: 400 atau 600 atau 800
					// Jangan lupa ini catatan isi max points: bener2 harus lihat kondisi sisa RAM kamu saat akan menjalankan coding ini
					// menjalankan coding ini bisa menyebabkan Laptop/kompie kamu ngehang .. karena RAM tidak cukup
					// note by rae
					max_points: 300,
					elevation: _elevation
				})

				hyperlapse.onError = function (e) {
					show('ERROR: ' + e.message)
				}

				hyperlapse.onRouteProgress = function (e) {
					_route_markers.push(
						new google.maps.Marker({
							position: e.point.location,
							draggable: false,
							icon: 'dot_marker.png',
							map: map
						})
					)
				}

				hyperlapse.onRouteComplete = function (e) {
					directions_renderer.setDirections(e.response)
					// show( "Number of Points: "+ hyperlapse.length() );
					show('')
					hyperlapse.load()
				}

				hyperlapse.onLoadProgress = function (e) {
					show('Loading: ' + (e.position + 1) + ' of ' + hyperlapse.length())
				}

				hyperlapse.onLoadComplete = function (e) {
					/*
				show( "" +
					"Start: " + start_pin.getPosition().toString() + 
					"<br>End: " + end_pin.getPosition().toString() + 
					"<br>Lookat: " + pivot_pin.getPosition().toString() + 
					"<br>Ready." );
				*/
					show('')
				}

				hyperlapse.onFrame = function (e) {
					/*
				show( "" +
					"Start: " + start_pin.getPosition().toString() + 
					"<br>End: " + end_pin.getPosition().toString() + 
					"<br>Lookat: " + pivot_pin.getPosition().toString() + 
					"<br>Position: "+ (e.position+1) +" of "+ hyperlapse.length() );
				*/
					camera_pin.setPosition(e.point.location)
				}

				pano.addEventListener(
					'mousedown',
					function (e) {
						e.preventDefault()

						is_moving = true

						onPointerDownPointerX = e.clientX
						onPointerDownPointerY = e.clientY

						px = hyperlapse.position.x
						py = hyperlapse.position.y
					},
					false
				)

				pano.addEventListener(
					'mousemove',
					function (e) {
						e.preventDefault()
						var f = hyperlapse.fov() / 500

						if (is_moving) {
							var dx = (onPointerDownPointerX - e.clientX) * f
							var dy = (e.clientY - onPointerDownPointerY) * f
							hyperlapse.position.x = px + dx // reversed dragging direction (thanks @mrdoob!)
							hyperlapse.position.y = py + dy

							o.position_x = hyperlapse.position.x
							o.position_y = hyperlapse.position.y
						}
					},
					false
				)

				pano.addEventListener(
					'mouseup',
					function () {
						is_moving = false

						hyperlapse.position.x = px
						//hyperlapse.position.y = py;
					},
					false
				)

				/* Dat GUI */

				var gui = new dat.GUI()

				var o = {
					distance_between_points: 1,
					// max points adalah banyak Frame/Foto yang diambil
					// hati2 dengan variabel max points ini jangan besar2 kalau Laptop/Komputer anda tidak punya memory besar
					// sebagai patokan bila Laptop/Komputer kamu RAM 2 GB yah setting max points: 50 atau 100 atau 200
					// kalo laptop kamu RAM 4 GB boleh setting max points: 100 atau 200 atau 400
					// kalo laptop kamu RAM 8 GB boleh setting max points: 400 atau 600 atau 800 atau 1000
					// Jangan lupa ini catatan isi max points: bener2 harus lihat kondisi sisa RAM kamu saat akan menjalankan coding ini
					// menjalankan coding ini bisa menyebabkan Laptop/kompie kamu ngehang .. karena RAM tidak cukup
					// note by rae
					max_points: 300,
					fov: 80,
					elevation: Math.floor(_elevation),
					tilt: 0,
					// millis, untuk mengatur kecepatan frame, semakin rendah semakin cepat, semakin tinggi semakin tinggi pergerakan frame, by rae
					millis: 1000,
					offset_x: 0,
					offset_y: 0,
					offset_z: 0,
					position_x: 0,
					position_y: 0,
					use_lookat: true,
					screen_width: window.innerWidth,
					screen_height: window.innerHeight,
					generate: function () {
						// show( "Generating route..." );

						directions_renderer.setDirections({ routes: [] })

						// var marker;
						while (_route_markers.length > 0) {
							marker = _route_markers.pop()
							marker.setMap(null)
						}

						request = {
							origin: start_point,
							destination: end_point,
							travelMode: google.maps.DirectionsTravelMode.DRIVING
						}

						directions_service.route(request, function (response, status) {
							if (status == google.maps.DirectionsStatus.OK) {
								hyperlapse.generate({ route: response })
							} else {
								console.log(status)
							}
						})
					},
					drop_pins: function () {
						var bounds = map.getBounds()
						var top_left = bounds.getNorthEast()
						var bot_right = bounds.getSouthWest()
						var hdif = Math.abs(top_left.lng() - bot_right.lng())
						var spacing = hdif / 4

						var center = map.getCenter()
						var c1 = new google.maps.LatLng(
							center.lat(),
							center.lng() - spacing
						)
						var c2 = new google.maps.LatLng(center.lat(), center.lng())
						var c3 = new google.maps.LatLng(
							center.lat(),
							center.lng() + spacing
						)

						hyperlapse.lookat = c2
						pivot_pin.setPosition(c2)

						snapToRoad(c1, function (result1) {
							start_pin.setPosition(result1)
							start_point = result1

							snapToRoad(c3, function (result3) {
								end_pin.setPosition(result3)
								end_point = result3
								changeHash()
							})
						})
					}
				}

				var scn = gui.addFolder('screen')

				scn.add(o, 'screen_width', window.innerHeight).listen()
				scn.add(o, 'screen_height', window.innerHeight).listen()

				var parameters = gui.addFolder('parameters')

				var distance_between_points_control = parameters.add(
					o,
					'distance_between_points',
					1,
					100
				)
				distance_between_points_control.onChange(function (value) {
					hyperlapse.setDistanceBetweenPoint(value)
				})

				// max points adalah banyak Frame/Foto yang diambil
				// hati2 dengan variabel max points ini jangan besar2 kalau Laptop/Komputer anda tidak punya memory besar
				// sebagai patokan bila Laptop/Komputer kamu RAM 2 GB yah setting max points: 50 atau 100 atau 200
				// kalo laptop kamu RAM 4 GB boleh setting max points: 100 atau 200 atau 400
				// kalo laptop kamu RAM 8 GB boleh setting max points: 400 atau 600 atau 800 atau 1000
				// Jangan lupa ini catatan isi max points: bener2 harus lihat kondisi sisa RAM kamu saat akan menjalankan coding ini
				// menjalankan coding ini bisa menyebabkan Laptop/kompie kamu ngehang .. karena RAM tidak cukup
				// note by rae
				var max_points = parameters.add(o, 'max_points', 10, 800)
				max_points.onChange(function (value) {
					hyperlapse.setMaxPoints(value)
				})

				var fov_control = parameters.add(o, 'fov', 1, 180)
				fov_control.onChange(function (value) {
					hyperlapse.setFOV(value)
				})

				var pitch_control = parameters.add(o, 'elevation', -1000, 1000)
				pitch_control.onChange(function (value) {
					_elevation = value
					hyperlapse.elevation_offset = value
					changeHash()
				})

				// millis, untuk mengatur kecepatan frame, semakin rendah semakin cepat, semakin tinggi semakin tinggi pergerakan frame, by rae
				var millis_control = parameters.add(o, 'millis', 10, 1000)
				millis_control.onChange(function (value) {
					hyperlapse.millis = value
				})

				var offset_x_control = parameters.add(o, 'offset_x', -360, 360)
				offset_x_control.onChange(function (value) {
					hyperlapse.offset.x = value
				})

				var offset_y_control = parameters.add(o, 'offset_y', -180, 180)
				offset_y_control.onChange(function (value) {
					hyperlapse.offset.y = value
				})

				var offset_z_control = parameters.add(o, 'offset_z', -360, 360)
				offset_z_control.onChange(function (value) {
					hyperlapse.offset.z = value
				})

				var position_x_control = parameters
					.add(o, 'position_x', -360, 360)
					.listen()
				position_x_control.onChange(function (value) {
					hyperlapse.position.x = value
				})

				var position_y_control = parameters
					.add(o, 'position_y', -180, 180)
					.listen()
				position_y_control.onChange(function (value) {
					hyperlapse.position.y = value
				})

				var tilt_control = parameters.add(o, 'tilt', -Math.PI, Math.PI)
				tilt_control.onChange(function (value) {
					hyperlapse.tilt = value
				})

				var lookat_control = parameters.add(o, 'use_lookat')
				lookat_control.onChange(function (value) {
					hyperlapse.use_lookat = value
				})

				// parameters.open();
				parameters.close()

				var play_controls = gui.addFolder('play controls')
				play_controls.add(hyperlapse, 'play')
				play_controls.add(hyperlapse, 'pause')
				play_controls.add(hyperlapse, 'next')
				play_controls.add(hyperlapse, 'prev')
				play_controls.open()
				// BILA mau play control di close, by rae
				// play_controls.close();
				/*
			gui.add(o, 'drop_pins');
			gui.add(o, 'generate');
			gui.add(hyperlapse, 'load');
		*/

				window.addEventListener(
					'resize',
					function () {
						hyperlapse.setSize(window.innerWidth, window.innerHeight)
						o.screen_width = window.innerWidth
						o.screen_height = window.innerHeight
					},
					false
				)

				var show_ui = true
				document.addEventListener('keydown', onKeyDown, false)
				function onKeyDown(event) {
					switch (event.keyCode) {
						case 72 /* H */:
							show_ui = !show_ui
							document.getElementById('controls').style.opacity = show_ui
								? 1
								: 0
							break

						case 190 /* > */:
							hyperlapse.next()
							break

						case 188 /* < */:
							hyperlapse.prev()
							break
					}
				}

				o.generate()
			}

			window.onload = init
		</script>
	</head>
	<body>
		<div
			id="pano"
			style="
				position: absolute;
				left: 0;
				top: 0;
				right: 0;
				bottom: 0;
				z-index: -1;
			"
		></div>

		<div id="controls">
			<div
				id="map"
				style="
					width: 25vw;
					height: 35vh;
					position: absolute;
					bottom: 0;
					right: 0;
					padding: 0;
				"
			></div>

			<div id="controls" style="">
				<form id="map_form">
					<input type="hidden" name="address" id="address" />
					<button type="submit" id="searchButton" hidden="hidden">
						Search
					</button>
				</form>
			</div>

			<div
				id="text"
				style="
					width: 500px;
					height: 120px;
					float: left;
					padding-top: 10px;
					z-index: 0;
					border-style: hidden;
					border-width: medium;
				"
			></div>
		</div>
	</body>
</html>
